import chaptersData from '@/assets/data/chapters/index.json';
import moods from '@/assets/data/moods.json';

// Import verses for various moods
import verse_2_56 from '@/assets/data/slok/2/56/index.json';
import verse_2_62 from '@/assets/data/slok/2/62/index.json';
import verse_2_63 from '@/assets/data/slok/2/63/index.json';
import verse_5_26 from '@/assets/data/slok/5/26/index.json';
import verse_16_1 from '@/assets/data/slok/16/1/index.json';
import verse_16_2 from '@/assets/data/slok/16/2/index.json';
import verse_16_3 from '@/assets/data/slok/16/3/index.json';
import verse_16_21 from '@/assets/data/slok/16/21/index.json';
import verse_4_36 from '@/assets/data/slok/4/36/index.json';
import verse_4_37 from '@/assets/data/slok/4/37/index.json';
import verse_5_10 from '@/assets/data/slok/5/10/index.json';
import verse_9_30 from '@/assets/data/slok/9/30/index.json';
import verse_10_3 from '@/assets/data/slok/10/3/index.json';
import verse_14_6 from '@/assets/data/slok/14/6/index.json';
import verse_18_66 from '@/assets/data/slok/18/66/index.json';
import verse_11_44 from '@/assets/data/slok/11/44/index.json';
import verse_12_13 from '@/assets/data/slok/12/13/index.json';
import verse_12_14 from '@/assets/data/slok/12/14/index.json';
import verse_2_13 from '@/assets/data/slok/2/13/index.json';
import verse_2_20 from '@/assets/data/slok/2/20/index.json';
import verse_2_22 from '@/assets/data/slok/2/22/index.json';
import verse_2_25 from '@/assets/data/slok/2/25/index.json';
import verse_2_27 from '@/assets/data/slok/2/27/index.json';
import verse_2_66 from '@/assets/data/slok/2/66/index.json';
import verse_2_71 from '@/assets/data/slok/2/71/index.json';
import verse_4_39 from '@/assets/data/slok/4/39/index.json';
import verse_5_29 from '@/assets/data/slok/5/29/index.json';
import verse_8_28 from '@/assets/data/slok/8/28/index.json';
import verse_3_37 from '@/assets/data/slok/3/37/index.json';
import verse_3_41 from '@/assets/data/slok/3/41/index.json';
import verse_3_43 from '@/assets/data/slok/3/43/index.json';
import verse_5_22 from '@/assets/data/slok/5/22/index.json';
import verse_6_5 from '@/assets/data/slok/6/5/index.json';
import verse_6_6 from '@/assets/data/slok/6/6/index.json';
import verse_6_26 from '@/assets/data/slok/6/26/index.json';
import verse_6_35 from '@/assets/data/slok/6/35/index.json';
import verse_16_19 from '@/assets/data/slok/16/19/index.json';
import verse_18_71 from '@/assets/data/slok/18/71/index.json';
import verse_6_32 from '@/assets/data/slok/6/32/index.json';
import verse_9_29 from '@/assets/data/slok/9/29/index.json';
import verse_3_8 from '@/assets/data/slok/3/8/index.json';
import verse_3_20 from '@/assets/data/slok/3/20/index.json';
import verse_6_16 from '@/assets/data/slok/6/16/index.json';
import verse_18_39 from '@/assets/data/slok/18/39/index.json';
import verse_6_30 from '@/assets/data/slok/6/30/index.json';
import verse_13_16 from '@/assets/data/slok/13/16/index.json';
import verse_13_18 from '@/assets/data/slok/13/18/index.json';
import verse_2_3 from '@/assets/data/slok/2/3/index.json';
import verse_2_14 from '@/assets/data/slok/2/14/index.json';
import verse_5_21 from '@/assets/data/slok/5/21/index.json';
import verse_2_7 from '@/assets/data/slok/2/7/index.json';
import verse_3_2 from '@/assets/data/slok/3/2/index.json';
import verse_18_61 from '@/assets/data/slok/18/61/index.json';
import verse_4_10 from '@/assets/data/slok/4/10/index.json';
import verse_11_50 from '@/assets/data/slok/11/50/index.json';
import verse_18_30 from '@/assets/data/slok/18/30/index.json';
import verse_14_17 from '@/assets/data/slok/14/17/index.json';
import verse_17_25 from '@/assets/data/slok/17/25/index.json';
import verse_16_4 from '@/assets/data/slok/16/4/index.json';
import verse_16_13 from '@/assets/data/slok/16/13/index.json';
import verse_16_18 from '@/assets/data/slok/16/18/index.json';
import verse_18_26 from '@/assets/data/slok/18/26/index.json';
import verse_11_33 from '@/assets/data/slok/11/33/index.json';
import verse_18_48 from '@/assets/data/slok/18/48/index.json';
import verse_18_78 from '@/assets/data/slok/18/78/index.json';
import verse_2_60 from '@/assets/data/slok/2/60/index.json';
import verse_2_61 from '@/assets/data/slok/2/61/index.json';
import verse_2_70 from '@/assets/data/slok/2/70/index.json';
import verse_7_14 from '@/assets/data/slok/7/14/index.json';
import verse_15_15 from '@/assets/data/slok/15/15/index.json';
import verse_9_22 from '@/assets/data/slok/9/22/index.json';
import verse_9_34 from '@/assets/data/slok/9/34/index.json';
import verse_1_1 from '@/assets/data/slok/1/1/index.json';
import verse_1_2 from '@/assets/data/slok/1/2/index.json';
import verse_2_47 from '@/assets/data/slok/2/47/index.json';
import verse_2_48 from '@/assets/data/slok/2/48/index.json';
import verse_3_19 from '@/assets/data/slok/3/19/index.json';


// Types for verse data
export interface Verse {
  slok: string;
  transliteration: string;
  tej: {
    ht: string;
    et: string;
  };
  siva?: {
    et: string;
  };
  purohit?: {
    et: string;
  };
  chinmay?: {
    hc: string;
  };
  chapter: number;
  verse: number;
}

// Direct mapping of verses for quick access
const verseMap: { [key: string]: any } = {
  '2-56': verse_2_56,
  '2-62': verse_2_62,
  '2-63': verse_2_63,
  '5-26': verse_5_26,
  '16-1': verse_16_1,
  '16-2': verse_16_2,
  '16-3': verse_16_3,
  '16-21': verse_16_21,
  '4-36': verse_4_36,
  '4-37': verse_4_37,
  '5-10': verse_5_10,
  '9-30': verse_9_30,
  '10-3': verse_10_3,
  '14-6': verse_14_6,
  '18-66': verse_18_66,
  '11-44': verse_11_44,
  '12-13': verse_12_13,
  '12-14': verse_12_14,
  '2-13': verse_2_13,
  '2-20': verse_2_20,
  '2-22': verse_2_22,
  '2-25': verse_2_25,
  '2-27': verse_2_27,
  '2-66': verse_2_66,
  '2-71': verse_2_71,
  '4-39': verse_4_39,
  '5-29': verse_5_29,
  '8-28': verse_8_28,
  '3-37': verse_3_37,
  '3-41': verse_3_41,
  '3-43': verse_3_43,
  '5-22': verse_5_22,
  '6-5': verse_6_5,
  '6-6': verse_6_6,
  '6-26': verse_6_26,
  '6-35': verse_6_35,
  '16-19': verse_16_19,
  '18-71': verse_18_71,
  '6-32': verse_6_32,
  '9-29': verse_9_29,
  '3-8': verse_3_8,
  '3-20': verse_3_20,
  '6-16': verse_6_16,
  '18-39': verse_18_39,
  '6-30': verse_6_30,
  '13-16': verse_13_16,
  '13-18': verse_13_18,
  '2-3': verse_2_3,
  '2-14': verse_2_14,
  '5-21': verse_5_21,
  '2-7': verse_2_7,
  '3-2': verse_3_2,
  '18-61': verse_18_61,
  '4-10': verse_4_10,
  '11-50': verse_11_50,
  '18-30': verse_18_30,
  '14-17': verse_14_17,
  '17-25': verse_17_25,
  '16-4': verse_16_4,
  '16-13': verse_16_13,
  '16-18': verse_16_18,
  '18-26': verse_18_26,
  '11-33': verse_11_33,
  '18-48': verse_18_48,
  '18-78': verse_18_78,
  '2-60': verse_2_60,
  '2-61': verse_2_61,
  '2-70': verse_2_70,
  '7-14': verse_7_14,
  '15-15': verse_15_15,
  '9-22': verse_9_22,
  '9-34': verse_9_34,
  '1-1': verse_1_1,
  '1-2': verse_1_2,
  '2-47': verse_2_47,
  '2-48': verse_2_48,
  '3-19': verse_3_19,
};

// Helper function to normalize mood names with more robust handling
const normalizeMoodName = (mood: string): string => {
  const normalized = mood.toLowerCase()
    .replace(/[^a-z0-9]+/g, '_')
    .replace(/^_+|_+$/g, '')
    .trim();
  console.log(`Normalizing mood name: "${mood}" -> "${normalized}"`);
  return normalized;
};

// Helper function to generate verse key
export const generateVerseKey = (chapter: number, verse: number) =>
  `${chapter}-${verse}`;

// Get a verse by chapter and number with improved error handling
export const getVerseByChapterAndNumber = async (chapter: number, verse: number): Promise<Verse | null> => {
  try {
    const verseKey = generateVerseKey(chapter, verse);
    console.log(`Loading verse ${verseKey} from verseMap`);

    if (!verseMap[verseKey]) {
      console.error(`Verse ${verseKey} not found in verseMap. Available verses:`, Object.keys(verseMap).join(', '));
      return null;
    }

    const verseData = verseMap[verseKey].default;
    if (!verseData) {
      console.error(`No default export found for verse ${verseKey}`);
      return null;
    }

    console.log(`Successfully loaded verse ${verseKey}`);
    return {
      ...verseData,
      chapter,
      verse
    };
  } catch (error) {
    console.error(`Error loading verse ${chapter}:${verse}:`, error);
    return null;
  }
};

// Import all verses
import verse_2_56 from '@/assets/data/slok/2/56/index.json' assert { type: 'json' };
import verse_2_62 from '@/assets/data/slok/2/62/index.json' assert { type: 'json' };
// ... (keep other verse imports)

const verseMap = {
  '2-56': verse_2_56,
  '2-62': verse_2_62,
  // ... (add all other verses)
};

// Get verses for a specific mood with improved error handling
export const getVersesByMood = async (mood: string): Promise<Verse[]> => {
  try {
    const searchMood = mood.toUpperCase();
    console.log(`Looking for verses for mood: "${searchMood}"`);

    // Find mood data
    const moodData = moods.moods.find(m => m.name === searchMood);

    if (!moodData?.verses?.length) {
      console.warn(`No verses defined for mood: "${searchMood}"`);
      return [];
    }

    console.log(`Found ${moodData.verses.length} verses for mood "${searchMood}":`, 
      moodData.verses.map(v => `${v.chapter}:${v.verse}`).join(', '));

    const verses = moodData.verses.map(verseRef => {
      const key = `${verseRef.chapter}-${verseRef.verse}`;
      const verse = verseMap[key];
      
      if (!verse) {
        console.error(`Missing verse data for ${key}`);
        return null;
      }
      
      return {
        ...verse,
        chapter: verseRef.chapter,
        verse: verseRef.verse,
        theme: verseRef.theme
      };
    });

    const validVerses = verses.filter((v): v is Verse => v !== null);
    console.log(`Successfully loaded ${validVerses.length} out of ${moodData.verses.length} verses for mood ${searchMood}`);

    if (validVerses.length === 0) {
      console.error('No verses were loaded successfully for mood:', searchMood);
      console.error('Available verses in verseMap:', Object.keys(verseMap).join(', '));
      console.error('Available moods:', moods.moods.map(m => `${m.name} (${m.verses.length} verses)`));
    }

    return validVerses;
  } catch (error) {
    console.error('Error loading verses for mood:', error);
    return [];
  }
};

// Get random verse with improved error handling
export const getRandomVerse = async (): Promise<Verse | null> => {
  try {
    const chapters = getChapters();
    const maxAttempts = 3;
    let attempts = 0;

    // Get list of available verse keys
    const availableVerses = Object.keys(verseMap);
    if (availableVerses.length === 0) {
      console.error('No verses available in verseMap');
      return null;
    }

    while (attempts < maxAttempts) {
      try {
        // Instead of random chapter/verse, pick from available verses
        const randomIndex = Math.floor(Math.random() * availableVerses.length);
        const [chapter, verse] = availableVerses[randomIndex].split('-').map(Number);

        console.log(`Getting random verse ${chapter}:${verse}`);
        const verse_data = await getVerseByChapterAndNumber(chapter, verse);
        if (verse_data) return verse_data;

        attempts++;
      } catch (error) {
        console.error(`Attempt ${attempts + 1} failed:`, error);
        attempts++;
        if (attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 1000 * attempts));
        }
      }
    }

    console.error(`Failed to get random verse after ${maxAttempts} attempts`);
    return null;
  } catch (error) {
    console.error('Error getting random verse:', error);
    return null;
  }
};

// Export helper functions
export const getChapters = () => chaptersData;
export const preloadVersesByMood = (mood: string) => getVersesByMood(mood).catch(console.error);

// Types
export interface Chapter {
  chapter_number: number;
  verses_count: number;
  name: string;
  name_meaning: string;
  translation?: string;
  transliteration?: string;
  meaning?: {
    en: string;
    hi: string;
  };
  summary?: {
    en: string;
    hi: string;
  };
}